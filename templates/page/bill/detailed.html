
{% extends '_detailed_base.html' %}
    {% block bill_base %}
        <div class="header">
            <h1 class="page-header">
                明细(单位:元) <small>欢迎用户:{{ user_name }}</small>
            </h1>
            <ol class="breadcrumb">
                <li><a href="detailed">明细</a></li>
                <li class="active">数据</li>
            </ol>
		</div>
        <div id="page-inner">

            <div class="row">
                <div class="col-md-12">
                    <!-- Advanced Tables -->
                    <div class="panel panel-default">
                        <div class="panel-heading">
                            明细统计 &nbsp;&nbsp;&nbsp;
                            <button class="btn btn-warning" onclick="refresh_data()"><i class=" fa fa-refresh "></i> 刷新</button>
                            <button class="btn btn-success" onclick="set_model_attribute()"><i class="fa fa-edit "></i> 记一笔</button>
                            <div class="modal fade" id="addBill" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
                                <div class="modal-dialog">
                                    <div class="modal-content">
                                        <div class="modal-header">
                                            <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                                            <h4 class="modal-title" id="myModalLabel">记一笔</h4>
                                        </div>
                                        <div class="modal-body">
                                            <div class="row">
                                                <form id="bill_add_form">
                                                    <div class="col-md-6">
                                                        <label>消费分类</label>
                                                        <select class="form-control" id="bill_type" name="type">
                                                        </select>
                                                        <label>消费金额</label>
                                                        <input class="form-control" id="amount" name="amount" type="text" placeholder="保留一位小数...">
                                                    </div>
                                                    <div class="col-md-6">
                                                        <label>日期</label>
                                                        <input class="form-control" id="date" name="create_time" type="text" placeholder="date time ...">
                                                        <label>备注</label>
                                                        <input class="form-control" id="remark" name="remark" type="text" placeholder="remark ...">
                                                    </div>
                                                </form>
                                            </div>
                                        </div>
                                        <div class="modal-footer">
                                            <button type="button" class="btn btn-success" id="save_bill">保存</button>
                                            <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
                                        </div>
                                    </div>
                                 </div>
                                </div>
                                <button class="btn btn-danger" onclick="remove_bill()"><i class="fa fa-trash-o"></i> 删一单</button>

                            </div>
                        <div class="panel-body">
                            <div class="table-responsive">
                                <table class="table table-striped table-bordered table-hover" id="dataTables-example">
                                    <thead>
                                        <tr>
                                            <th>
                                                <input type="checkbox" id="checkall" onclick="func_check_all()"/>
                                            </th>
                                            <th>消费类型</th>
                                            <th>消费金额</th>
                                            <th>消费日期</th>
                                            <th>备注</th>
                                            <th>操作</th>
                                        </tr>
                                    </thead>
                                </table>
                            </div>
                        </div>
                    </div>
                    <!--End Advanced Tables -->
                </div>
            </div>
                <!-- /. ROW  -->

        </div>

    {% endblock bill_base%}

    {% block js_script %}
        <script>
            $(function () {
                get_bill_type();
            });

            function get_bill_type() {
                $.ajax({
                    url: 'get_type',
                    dataType: 'json',
                    type: 'get',
                    success: function (data) {
                        if (data){
                            $('#bill_type').append(data);
                        }
                    }
                });
            }
            $(document).ready(function () {
                $('#dataTables-example').DataTable({
                    "serverSide": true,
                    "retrieve": true,
                    "processing": true,
                    "ordering": false,
                    "searching": false,
                    "pagingType": "full_numbers",
                    "lengthMenu": [10, 20, 30, 40],
                    language: dtLanguage,
                    "ajax": {
                        url: 'get_table_data',
                        type: 'get'
                    },
                    columnDefs:[
                        {
                            "targets": [5],
                            data: "id",
                            "render": function (data, type, row) {
                                return '<a href="#" onclick="detailed_bill(' + row['id'] + ')" data-toggle="modal" data-target="#editModal" class="btn btn-default btn-xs"><i class="fa fa-paperclip"></i>详情</a>&nbsp;&nbsp;' +
                                        '<a href="javascript:void(0)" onclick="edit_bill('+ row['id'] +')" class="btn btn-primary btn-xs" role="button"><i class="fa fa-edit"></i>编&nbsp;辑</a>'
                            }
                        }
                    ],
                    columns: [
                        {data: 'select'},
                        {data: 'type'},
                        {data: 'amount'},
                        {data: 'date'},
                        {data: 'remark'}
                    ]
                });
            });

            function set_model_attribute() {
                $('#addBill').modal({
                    "backdrop": "static",
                     "keyboard": false
                });
                $('#addBill').modal('show');
            }

            function func_check_all() {
                if ($("#checkall").is(':checked') == true) {
                    $('.select').each(function () {
                        $(this).prop('checked', true);
                        // $(this).attr('checked', true);
                        $('.select').on("click", func_add(this));
                    });
                } else {
                    $('.select').each(function () {
                        $(this).prop('checked', false);
                        // $(this).attr('checked', false);
                        $('.select').on("click", func_remove(this));
                    });
                }
            }

            function func_add(doc) {
                $(doc).parent().parent().addClass('selected');
            }

            function func_remove(doc) {
                $(doc).parent().parent().removeClass('selected');
            }
            function func_select(doc) {
                $(doc).parent().parent().toggleClass('selected');
            }

            function refresh_data(){
                window.location.href = 'detailed';
            }

            //校检金额
            $(document).on('blur', '#amount', function () {
                var amount = $('#amount').val();
                var re = /^[0-9]+.?[0-9]*$/;
                if (!re.test(amount)){
                    layer.msg('请输入数字！');
                    $('#amount').focus();
                    return;
                }
                if (amount.indexOf('.') > 0){
                   return;
                }
                $('#amount').val(amount + '.0')
            });

            //记一笔
            $(document).on('click', '#save_bill',  function () {
                console.log('-==--==-=--=');
                var amount = $('#amount').val();
                var date = $('#date').val();
                var remark = $('#remark').val().trim();
                if (amount.length === 0 || amount === ""){
                    layer.msg('请输入金额');
                    $('#amount').focus();
                    return;
                }
                if (date.length === 0 || date === ""){
                    layer.msg('请选择日期');
                    $('#date').focus();
                    return;
                }
                if (remark.length === 0 || remark === ""){
                    layer.msg('请输入备注');
                    $('#remark').focus();
                    return;
                }
                $.ajax({
                    url: 'bill_data_add',
                    data: $('#bill_add_form').serializeArray(),
                    dataType: 'json',
                    type: 'POST',
                    success: function (data) {
                        if (data === '1'){
                            layer.msg('记录成功');
                            $('#addBill').modal('hide');
                            $('#dataTables-example').DataTable().draw(false);
                            $('#amount').val('');
                            $('#date').val('');
                            $('#remark').val('');
                        }else {
                            layer.msg(data);
                        }
                    }
                });
            });

            //删一单
            function remove_bill() {
                var table = $('#dataTables-example').DataTable();
                var data = table.rows('.selected').data();
                var bills_id = [];
                for (var i=0 ; i < data.length ; i++) {
                    var id = data[i]['id'];
                    bills_id.push(id);
                }
                if (bills_id.length){
                    layer.confirm('确认删除吗?', {icon: 3, title: '提示'}, function (index) {
                        $.ajax({
                            url: 'bill_data_delete',
                            dataType: 'json',
                            traditional: true,
                            type: 'POST',
                            data: {'bills_id': bills_id},
                            success: function (data) {
                                if (data === '1'){
                                    layer.msg('操作成功');
                                    $('#dataTables-example').DataTable().draw(false);
                                }else {
                                    layer.msg(data);
                                }
                                layer.close(index);
                            }
                        });
                    });
                }else {
                    layer.msg('请至少选择一项！');
                }
            }
        </script>
    {% endblock %}


